"use strict";define("module/aliOSS",["plupload","uuid"],function(require){xLog("module/aliOSS~");var uuid=require("uuid");return function(targerID,containerID,types,onUploaded){if(!targerID||!containerID||!types){return alert("\u7F3A\u5C11\u5FC5\u586B\u53C2\u6570\uFF0C\u5177\u4F53\u7528\u6CD5\u8BF7\u67E5\u770Bmodule/aliOSS")}var accessid="";var host="";var policyBase64="";var signature="";var callbackbody="";var key="";var expire=0;var gObjectName="";var gObjectNameType="";var timestamp=Date.parse(new Date)/1000;var now=timestamp;var suffix="";var extensions={image:[".jpg",".jpeg",".png",".gif",".bmp"],video:[".mp4",".avi",".wmv",".rm",".rmvb",".mkv","mov"],audio:[".mp3",".wma",".wav",".amr"],attachment:[".txt",".pdf",".doc",".docx",".xls",".xlsx",".ppt",".pptx",".zip",".rar"]};function getFileType(type){var fileType="";for(var ext in extensions){if(extensions.hasOwnProperty(ext)){extensions[ext].forEach(function(ele){if(ele.indexOf(type)!==-1){return fileType=ext}})}}return fileType}function sendRequest(){var xmlhttp=null;if(window.XMLHttpRequest){xmlhttp=new XMLHttpRequest}else if(window.ActiveXObject){xmlhttp=new ActiveXObject("Microsoft.XMLHTTP")}if(xmlhttp!==null){var serverUrl=vars.urlSignature;xmlhttp.open("POST",serverUrl,false);xmlhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");xmlhttp.send(null);return xmlhttp.responseText}alert("Your browser does not support XMLHTTP.")}function checkObjectRadio(){gObjectNameType=vars.uploadNameType}function getSignature(){now=timestamp=Date.parse(new Date)/1000;if(expire<now+3){var body=sendRequest();var obj=eval("("+body+")");host=obj.host;policyBase64=obj.policy;accessid=obj.accessid;signature=obj.signature;expire=parseInt(obj.expire);callbackbody=obj.callback;key=obj.dir;return true}return false}function getSuffix(filename){var pos=filename.lastIndexOf(".");suffix="";if(pos!==-1){suffix=filename.substring(pos)}return suffix}function calculateObjectName(filename){if(gObjectNameType==="local"){gObjectName+="${filename}"}else if(gObjectNameType==="random"){suffix=getSuffix(filename);gObjectName=key+uuid()+suffix}else{suffix=getSuffix(filename);gObjectName=key+uuid()+suffix}return""}function setUploadParam(up,filename,ret){if(ret===false){ret=getSignature()}gObjectName=key;if(filename!==""){suffix=getSuffix(filename);calculateObjectName(filename)}var newMultipartParams={key:gObjectName,policy:policyBase64,OSSAccessKeyId:accessid,success_action_status:"200",callback:callbackbody,signature:signature};up.setOption({url:host,multipart_params:newMultipartParams});up.start()}function getMimeTypes(types){var mimeTypes={image:{title:"image",extensions:"jpg,gif,png,bmp,jpeg"},attachment:{title:"attachment",extensions:"txt,pdf,doc,docx,xls,xlsx,ppt,pptx,zip,rar"},video:{title:"video",extensions:"mp4,avi,wmv,rm,rmvb,mkv,mov"},audio:{title:"audio",extensions:"mp3,wma,wav,amr"}};var mimeArr=[];var mime=mimeTypes[types];if(mime){mimeArr.push(mime)}else{$.alert("aliOSS\u4E0A\u4F20\u7EC4\u4EF6\u8C03\u7528\u6709\u8BEF")}return mimeArr}var uploader=new plupload.Uploader({runtimes:"html5,flash,silverlight,html4",browse_button:targerID,multi_selection:false,container:document.getElementById(containerID),flash_swf_url:"//cdn.bootcss.com/plupload/2.1.2/Moxie.swf",silverlight_xap_url:"lib/plupload-2.1.2/js/Moxie.xap",url:"http://oss.aliyuncs.com",filters:{mime_types:getMimeTypes(types),max_file_size:"10mb",prevent_duplicates:true},init:{PostInit:function PostInit(){xLog("upload init")},FilesAdded:function FilesAdded(up,files){plupload.each(files,function(file){xLog(file,file.id,file.name,plupload.formatSize(file.size))});setUploadParam(uploader,"",false)},BeforeUpload:function BeforeUpload(up,file){checkObjectRadio();setUploadParam(up,file.name,true)},UploadProgress:function UploadProgress(up,file){xLog("Progress",file.percent)},FileUploaded:function FileUploaded(up,file,info){xLog("uploaded:",up,file,info);xLog(suffix);var hostURL=host;onUploaded&&onUploaded(up,file,info,hostURL,gObjectName)},Error:function Error(up,err){if(err.code===-600){$.alert("\n\u9009\u62E9\u7684\u6587\u4EF6\u592A\u5927\u4E86\uFF0C\u5F53\u524D\u9650\u5236\u4E3A10MB")}else if(err.code===-601){$.alert("\n\u53EA\u652F\u6301\u4EE5\u4E0B\u683C\u5F0F<br>"+extensions[types]+"<br>\u4F60\u4E0A\u4F20\u7684\u6587\u4EF6\u540D\u4E3A:<br>"+err.file.name,"\u6269\u5C55\u540D\u4E0D\u7B26\u5408\u8981\u6C42");console.log(up)}else if(err.code===-602){$.alert("\n\u8FD9\u4E2A\u6587\u4EF6\u5DF2\u7ECF\u4E0A\u4F20\u8FC7\u4E00\u904D\u4E86")}else{$.alert("\nError xml:"+err.response)}}}});uploader.init()}});